<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.devoca.quiz.model.mapper.QuizMapper">

    <!--  QuizDTO 매핑  -->
    <resultMap id="QuizDTOMap" type="QuizDTO">
        <result property="wordId" column="word_id"/>
        <result property="wordNameKr" column="word_name_kr"/>
        <result property="wordNameEn" column="word_name_en"/>
        <result property="wordSumm" column="word_summ"/>
    </resultMap>

    <!--  퀴즈 생성 : 게릴라-0, 대결-1  -->
    <insert id="createQuizId">
        insert into quizzes (quiz_type)
        values(#{type});
    </insert>

    <!--  생성한 퀴즈 아이디 가져오기 : 게릴라-0, 대결-1  -->
    <select id="getQuizId" resultType="int">
        select quiz_id from quizzes
        where quiz_type = #{type}
        order by quiz_create_date desc
            limit 1;
    </select>

    <!--  게릴라 퀴즈 문제 생성  -->
    <select id="createQuizWordList" resultMap="QuizDTOMap">
        select word_id, word_name_kr, word_name_en, word_summ
        from words
        order by RAND()
            limit 10;
    </select>

    <!--  생성한 퀴즈 문제 저장  -->
    <insert id="saveQuizWord" parameterType="map">
        insert into quiz_words (qw_word_id, qw_quiz_id)
        values
            <foreach collection="quizList" item="quiz" separator=",">
                (#{quiz.wordId}, #{quizId})
            </foreach>;
    </insert>

    <!--  퀴즈 문제 가져오기  -->
    <select id="getQuizWordList" parameterType="int" resultMap="QuizDTOMap">
        select word_id, word_name_kr, word_name_en, word_summ
        from words w join quiz_words qw
            on w.word_id = qw.qw_word_id
        where qw_quiz_id = #{quizId};
    </select>

    <!--  퀴즈 결과 저장하기  -->
    <insert id="saveQuizResult" parameterType="QuizResultDTO">
        insert into quiz_participants (qp_quiz_id, fk_qp_user_idx, qp_score)
        values (#{quizId}, #{userIdx}, #{score});
    </insert>

    <!--  퀴즈 답 저장하기  -->
    <insert id="saveQuizAnswerList" parameterType="map">
        insert into quiz_answers (qw_id, qa_user_idx, qa_answer, qa_yn)
            values
        <foreach collection="list" item="item" separator=",">
                ((select qw_id from quiz_words where qw_word_id = #{item.quizWordId}), #{userIdx}, #{item.quizAnswer}, #{item.quizYn})
        </foreach>
    </insert>

</mapper>