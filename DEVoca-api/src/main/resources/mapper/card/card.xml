<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.devoca.card.model.mapper.CardMapper">

    <!--  CardDTO 매핑 -->
    <resultMap id="CardDTOResultMap" type="CardDTO">
        <result property="userId" column="user_id"/>
        <result property="userNickName" column="user_nickname"/>
        <result property="userIntro" column="user_intro"/>
        <result property="userImg" column="user_img"/>
        <result property="wordId" column="word_id"/>
        <result property="wordNameKr" column="word_name_kr"/>
        <result property="wordNameEn" column="word_name_en"/>
        <result property="wordSumm" column="word_summ"/>
        <result property="wordCategory" column="category_name"/>
        <result property="originCardId" column="origin_card_id"/>
        <result property="originUserNickName" column="origin_user_nickname"/>
        <result property="originUserImg" column="origin_user_img"/>
        <result property="originCardContent" column="origin_card_content"/>
        <result property="cardId" column="card_id"/>
        <result property="cardContent" column="card_content"/>
        <result property="cardLikeYN" column="card_like_yn"/>
        <result property="cardLikeCnt" column="card_like_cnt"/>
        <result property="cardRepostCnt" column="card_repost_cnt"/>
        <result property="cardRegistDate" column="card_regist_date"/>
        <result property="cardUpdateDate" column="card_update_date"/>
    </resultMap>

    <!--  userId로 userIdx 불러오기  -->
    <sql id="userIdxLoad">
        select user_idx from users where user_id = #{userId}
    </sql>

    <!--  userId가 follow하는 userIdx 불러오기  -->
    <sql id="userFollowIdx">
        select u.user_idx
        from users u right join follows f
        on u.user_idx = f.follow_to
        where f.follow_from = (<include refid="userIdxLoad"></include>)
        union
        <include refid="userIdxLoad"></include>
    </sql>

    <!--  카드 등록  -->
    <select id="registerCard" parameterType="CardDTO">
        insert into cards (fk_card_user_idx, card_word_id, card_content, card_link, card_related_keyword)
        values((<include refid="userIdxLoad"></include> and user_revoke_date is null), #{wordId}, #{cardContent}, #{cardLink}, #{cardRelatedKeyword});
    </select>

    <!--  카드 수정  -->
    <update id="updateCard" parameterType="CardDTO">
        update cards
            set card_content = #{cardContent},
                card_link = #{cardLink},
                card_related_keyword = #{cardRelatedKeyword},
                card_update_date = now()
        where card_id = #{cardId};
    </update>

    <!--  카드 삭제  -->
    <update id="deleteCard" parameterType="int">
        update cards
        set card_delete_date = now()
        where card_id = #{cardId};
    </update>

    <!--  카드 상세 조회  -->
    <select id="getCardDetail" parameterType="int" resultMap="CardDTOResultMap">
        select user_id, user_nickname, user_intro, user_img,
               card_content, card_related_keyword,
               ifnull((select 'true' from likes
                       where like_from = (select user_idx from users where user_id = "ffasy")
                         and like_to = card_id), 'false')
               as card_like_yn,
               (select count('true') from likes where like_to = card_id) as card_like_cnt,
               card_repost_cnt, card_link, card_regist_date, card_update_date
        from cards c left join users u
            on c.fk_card_user_idx = u.user_idx
        where card_id = #{cardId}
        and card_delete_date is null;
    </select>

    <!--  카드 목록 조회  -->
    <select id="getCardList" parameterType="map" resultMap="CardDTOResultMap">
        select u.user_id, u.user_nickname, u.user_intro, u.user_img,
                card_content, card_id, card_regist_date, card_update_date,
                ifnull((select true from likes
                        where like_from = (<include refid="userIdxLoad"></include>)
                        and like_to = card_id), false)
                as card_like_yn,
                (select count('true') from likes where like_to = card_id) as card_like_cnt,
                word_id, word_name_kr, word_name_en, word_summ,
                (select category_name from categories
                where category_id in (select wc_category_id from words_categories where wc_word_id = word_id)
                limit 1)
                as category_name
        from users u right join cards c
        on u.user_idx = c.fk_card_user_idx
        left join words w
        on c.card_word_id = word_id
        where u.user_idx in (<include refid="userFollowIdx"></include>)
        and card_delete_date is null
        limit #{scroll}, 10;
    <!-- 재게시 기능 구현 후 로직 추가 예정 : 카드를 인용한 카드에서 select 항목 추가 및 join 추가 -->
    <!-- word 조회 기능과 merge 후 DTO, 조회 로직 이분화 예정 -->
    </select>
</mapper>